<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Imon - Secure AI Chat</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { 500: '#4f46e5', 600: '#4338ca' },
                        dark: { bg: '#131314', surface: '#1e1f20', input: '#282a2c' }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s infinite',
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        
        /* Markdown Styles */
        .prose { font-size: 0.95rem; line-height: 1.6; }
        .prose pre { background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 0.5rem 0; }
        .prose code { background: #f1f5f9; padding: 0.1rem 0.3rem; border-radius: 0.2rem; color: #ef4444; font-size: 0.875em; font-family: monospace; }
        .dark .prose code { background: #374151; color: #fca5a5; }
        
        /* Animation Utilities */
        .typing-cursor::after { content: '‚ñã'; animation: blink 1s step-start infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        
        .voice-active { animation: ring 1.5s infinite; }
        @keyframes ring {
            0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(79, 70, 229, 0); }
            100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-dark-bg text-gray-900 dark:text-gray-100 overflow-hidden transition-colors duration-200">

    <div id="loading" class="fixed inset-0 z-50 flex items-center justify-center bg-white dark:bg-dark-bg">
        <div class="animate-spin w-10 h-10 border-4 border-indigo-500 border-t-transparent rounded-full"></div>
    </div>

    <div id="app" class="flex w-full h-[100dvh] opacity-0 transition-opacity duration-500 relative">
        
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-30 w-72 transform -translate-x-full md:translate-x-0 md:static md:flex flex-col bg-gray-100 dark:bg-dark-surface border-r border-gray-200 dark:border-gray-800 transition-transform duration-300">
            <div class="p-4 flex items-center justify-between">
                <button onclick="app.toggleSidebar()" class="md:hidden p-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
                <div onclick="app.createNewChat()" class="cursor-pointer flex-1 flex items-center gap-2 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 px-4 py-3 rounded-xl font-medium hover:opacity-80">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg> New Chat
                </div>
            </div>
            <div class="flex-1 overflow-y-auto px-2 space-y-1" id="chat-history"></div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                <button onclick="app.openSettings()" class="flex items-center gap-3 w-full p-3 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-xl transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg> Settings
                </button>
            </div>
        </aside>
        
        <div id="sidebar-overlay" onclick="app.toggleSidebar()" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden"></div>

        <main class="flex-1 flex flex-col h-full relative w-full bg-white dark:bg-dark-bg">
            <header class="md:hidden flex items-center justify-between p-4 border-b border-gray-100 dark:border-gray-800">
                <button onclick="app.toggleSidebar()" class="p-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></button>
                <span class="font-bold text-lg bg-gradient-to-r from-indigo-500 to-purple-500 bg-clip-text text-transparent">Imon</span>
                <div class="w-8"></div>
            </header>

            <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6 scroll-smooth">
                <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-center opacity-70">
                    <div class="w-20 h-20 bg-indigo-100 dark:bg-indigo-900 rounded-full mb-4 flex items-center justify-center text-3xl animate-pulse-slow">üéôÔ∏è</div>
                    <h1 class="text-2xl font-bold mb-2">Voice & Vision AI</h1>
                    <p class="text-sm">Select a model, tap the mic, and speak.</p>
                </div>
            </div>

            <div class="p-4 border-t border-gray-100 dark:border-gray-800 bg-white dark:bg-dark-bg">
                <div class="max-w-4xl mx-auto flex items-end gap-2 bg-gray-100 dark:bg-dark-input rounded-[26px] p-2 pr-2 shadow-inner">
                    
                    <button id="mic-btn" onclick="app.toggleVoice()" class="p-3 text-gray-500 hover:text-red-500 dark:text-gray-400 transition rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" title="Voice Input">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
                    </button>

                    <textarea id="user-input" rows="1" class="flex-1 bg-transparent border-none focus:ring-0 text-gray-900 dark:text-white py-3 px-2 resize-none max-h-32 placeholder-gray-500" placeholder="Type or Speak..." oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();app.sendMessage();}"></textarea>
                    
                    <button onclick="app.sendMessage()" id="send-btn" class="p-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"/></svg>
                    </button>
                </div>
                <div class="flex justify-center mt-2">
                     <span id="active-model-badge" class="text-[10px] px-2 py-1 rounded-full bg-gray-200 dark:bg-gray-800 text-gray-500 border border-gray-300 dark:border-gray-700">Loading Model...</span>
                </div>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-dark-surface w-full max-w-md rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
            <div class="p-5 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center">
                <h2 class="text-xl font-bold">Settings</h2>
                <button onclick="app.closeSettings()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
            </div>
            
            <div class="p-5 space-y-6 overflow-y-auto">
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-500">OpenRouter API Key</label>
                    <input type="password" id="api-key" class="w-full bg-gray-50 dark:bg-dark-input border border-gray-200 dark:border-gray-700 rounded-xl px-4 py-3 outline-none focus:border-indigo-500 transition" placeholder="sk-or-...">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-500">Select Model</label>
                    <div class="flex gap-2 mb-2">
                        <select id="model-select" onchange="app.changeModel()" class="flex-1 bg-gray-50 dark:bg-dark-input border border-gray-200 dark:border-gray-700 rounded-xl px-4 py-3 outline-none appearance-none text-sm"></select>
                    </div>
                    
                    <div class="pt-2 border-t border-gray-100 dark:border-gray-700">
                        <label class="block text-xs font-medium mb-2 text-gray-400">Add Custom Model ID</label>
                        <div class="flex gap-2">
                            <input type="text" id="new-model-id" class="flex-1 bg-gray-50 dark:bg-dark-input border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 text-sm outline-none" placeholder="e.g. openai/gpt-4o">
                            <button onclick="app.addCustomModel()" class="bg-gray-200 dark:bg-gray-700 px-3 py-2 rounded-lg text-sm hover:bg-gray-300 dark:hover:bg-gray-600 transition">Add</button>
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium">Auto-Speak Response</span>
                    <button onclick="app.toggleTTS()" id="tts-toggle" class="w-12 h-6 rounded-full bg-indigo-600 relative transition-colors duration-200">
                        <div class="w-4 h-4 bg-white rounded-full absolute top-1 left-1 translate-x-6 transition-transform duration-200"></div>
                    </button>
                </div>

                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium">Dark Mode</span>
                    <button onclick="app.toggleDarkMode()" id="dark-toggle" class="w-12 h-6 rounded-full bg-gray-300 dark:bg-indigo-600 relative transition-colors duration-200">
                        <div class="w-4 h-4 bg-white rounded-full absolute top-1 left-1 transition-transform duration-200"></div>
                    </button>
                </div>
                
                <div class="pt-2">
                    <button onclick="app.clearData()" class="text-red-500 text-xs hover:underline">Reset All Data</button>
                </div>
            </div>

            <div class="p-4 bg-gray-50 dark:bg-dark-input/30">
                <button onclick="app.saveSettings()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * IMON AI - SECURE & FIXED VERSION
         * Issues Fixed: XSS Vulnerability, Truncated Code, CSS Colors, Error Handling
         */

        const app = (() => {
            const STORAGE_KEY = 'imon_voice_v2'; // Updated storage key version
            
            // PRE-LOADED MODELS
            const DEFAULT_MODELS = [
                { id: 'google/gemini-2.0-flash-lite-preview-02-05:free', name: 'Gemini 2.0 Flash (Free)' },
                { id: 'google/gemini-2.0-pro-exp-02-05:free', name: 'Gemini 2.0 Pro (Free)' },
                { id: 'deepseek/deepseek-r1:free', name: 'DeepSeek R1 (Thinking)' },
                { id: 'meta-llama/llama-3.3-70b-instruct:free', name: 'Llama 3.3 70B (Free)' },
                { id: 'mistralai/mistral-7b-instruct:free', name: 'Mistral 7B (Free)' },
                { id: 'openai/gpt-4o-mini', name: 'GPT-4o Mini' },
                { id: 'anthropic/claude-3.5-sonnet', name: 'Claude 3.5 Sonnet' }
            ];

            let state = {
                apiKey: '',
                savedModels: [...DEFAULT_MODELS],
                currentModel: DEFAULT_MODELS[0].id,
                system: 'You are Imon, a helpful AI assistant.',
                darkMode: false,
                voiceEnabled: true,
                chats: [],
                currentChatId: null
            };

            // Voice Setup
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition = null;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'en-US'; 
                recognition.interimResults = false;
            }

            const els = {
                app: document.getElementById('app'),
                loader: document.getElementById('loading'),
                chatContainer: document.getElementById('chat-container'),
                history: document.getElementById('chat-history'),
                input: document.getElementById('user-input'),
                modal: document.getElementById('settings-modal'),
                modelSelect: document.getElementById('model-select'),
                badge: document.getElementById('active-model-badge'),
                micBtn: document.getElementById('mic-btn'),
                sendBtn: document.getElementById('send-btn')
            };

            // --- SECURITY UTILS ---
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function init() {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (raw) {
                    try {
                        const parsed = JSON.parse(raw);
                        state = { ...state, ...parsed };
                        // Merge models
                        const savedIds = new Set(state.savedModels.map(m => m.id));
                        DEFAULT_MODELS.forEach(dm => {
                            if (!savedIds.has(dm.id)) state.savedModels.push(dm);
                        });
                    } catch (e) { console.error("Save data corrupted", e); }
                }
                
                applyTheme();
                renderHistory();
                populateModels();
                updateBadge();
                updateSettingsUI();
                
                if (!state.chats.length) createNewChat();
                else {
                    const exists = state.chats.find(c => c.id === state.currentChatId);
                    if (exists) selectChat(state.currentChatId);
                    else selectChat(state.chats[0].id);
                }
                
                // Voice Listeners
                if (recognition) {
                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        els.input.value = transcript;
                        els.micBtn.classList.remove('voice-active', 'text-red-500');
                        sendMessage(); 
                    };
                    recognition.onerror = () => { els.micBtn.classList.remove('voice-active', 'text-red-500'); };
                    recognition.onend = () => { els.micBtn.classList.remove('voice-active', 'text-red-500'); };
                }

                setTimeout(() => {
                    els.loader.classList.add('hidden');
                    els.app.classList.remove('opacity-0');
                }, 500);
            }

            function save() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            }

            // --- MODEL MANAGER ---
            function populateModels() {
                els.modelSelect.innerHTML = '';
                state.savedModels.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.id;
                    opt.textContent = m.name;
                    if(m.id === state.currentModel) opt.selected = true;
                    els.modelSelect.appendChild(opt);
                });
            }

            function addCustomModel() {
                const id = document.getElementById('new-model-id').value.trim();
                if (!id) return;
                // Basic check to prevent duplicates
                if (state.savedModels.some(m => m.id === id)) {
                    alert('Model already exists');
                    return;
                }
                state.savedModels.push({ id: id, name: id.split('/')[1] || id });
                state.currentModel = id;
                save();
                populateModels();
                updateBadge();
                document.getElementById('new-model-id').value = '';
            }

            function changeModel() {
                state.currentModel = els.modelSelect.value;
                updateBadge();
                save();
            }

            function updateBadge() {
                const m = state.savedModels.find(x => x.id === state.currentModel);
                els.badge.textContent = m ? m.name : 'Unknown Model';
            }

            // --- UI & TOGGLES ---
            function toggleVoice() {
                if (!recognition) { alert("Voice not supported in this browser."); return; }
                if (els.micBtn.classList.contains('voice-active')) {
                    recognition.stop();
                } else {
                    els.micBtn.classList.add('voice-active', 'text-red-500');
                    recognition.start();
                }
            }

            function toggleTTS() {
                state.voiceEnabled = !state.voiceEnabled;
                updateSettingsUI();
                save();
            }

            function toggleDarkMode() {
                state.darkMode = !state.darkMode;
                applyTheme();
                updateSettingsUI();
                save();
            }

            function updateSettingsUI() {
                // TTS Toggle UI
                const ttsBtn = document.getElementById('tts-toggle');
                const ttsKnob = ttsBtn.firstElementChild;
                if (state.voiceEnabled) {
                    ttsKnob.classList.add('translate-x-6');
                    ttsBtn.classList.add('bg-indigo-600');
                    ttsBtn.classList.remove('bg-gray-300');
                } else {
                    ttsKnob.classList.remove('translate-x-6');
                    ttsBtn.classList.remove('bg-indigo-600');
                    ttsBtn.classL
